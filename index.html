<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–Ω—Ç–µ—Ö AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh;
        }
        .chat-container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: hidden;
        }
        .chat-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            text-align: center;
        }
        #messages { 
            height: 400px; 
            overflow-y: auto; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .message { 
            margin: 10px 0; 
            padding: 12px 16px; 
            border-radius: 18px; 
            max-width: 80%; 
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }
        .user { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
            margin-left: auto; 
            text-align: right;
        }
        .assistant { 
            background: white; 
            border: 1px solid #e0e0e0; 
            margin-right: auto;
        }
        #quick-replies { 
            padding: 15px 20px; 
            background: #f8f9fa; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px;
        }
        .quick-reply { 
            padding: 10px 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quick-reply:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .input-container { 
            padding: 20px; 
            background: white; 
            display: flex; 
            gap: 10px;
        }
        #message-input { 
            flex: 1; 
            padding: 12px 16px; 
            border: 2px solid #e0e0e0; 
            border-radius: 25px; 
            outline: none;
            font-size: 16px;
        }
        #message-input:focus { 
            border-color: #667eea;
        }
        #send-btn { 
            padding: 12px 24px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        #send-btn:hover { 
            transform: translateY(-2px);
        }
        #send-btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed;
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .loading { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #667eea; 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ü§ñ –≠–Ω—Ç–µ—Ö AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</h1>
            <p>–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</p>
        </div>
        
        <div id="messages"></div>
        
        <div id="quick-replies">
            <button class="quick-reply" data-message="–í–∞—à –≤–∞—Ä–∏–∞–Ω—Ç">üí¨ –í–∞—à –≤–∞—Ä–∏–∞–Ω—Ç</button>
            <button class="quick-reply" data-message="–æ—Ñ–∏—Å">üíº –û—Ñ–∏—Å</button>
            <button class="quick-reply" data-message="—É–ª–∏—Ü–∞">üèôÔ∏è –£–ª–∏—Ü–∞</button>
            <button class="quick-reply" data-message="—Ü–µ—Ö">üè≠ –¶–µ—Ö</button>
        </div>
        
        <div class="input-container">
            <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Ç–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è –∏–ª–∏ –≤–∞—à –≤–æ–ø—Ä–æ—Å...">
            <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // CSP-safe: –í–µ—Å—å JS –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–ª–æ–∫–µ, –±–µ–∑ inline handlers
        document.addEventListener('DOMContentLoaded', function() {
            const messagesDiv = document.getElementById('messages');
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const quickReplies = document.querySelectorAll('.quick-reply');
            
            // Quick Reply handlers
            quickReplies.forEach(btn => {
                btn.addEventListener('click', function() {
                    const message = this.getAttribute('data-message');
                    if (message === '–í–∞—à –≤–∞—Ä–∏–∞–Ω—Ç') {
                        // –î–ª—è "–í–∞—à –≤–∞—Ä–∏–∞–Ω—Ç" –ø—Ä–æ—Å—Ç–æ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ input
                        input.focus();
                        input.placeholder = '–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Ç–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è...';
                    } else {
                        sendMessage(message);
                    }
                });
            });
            
            // Send button handler
            sendBtn.addEventListener('click', function() {
                sendMessage();
            });
            
            // Enter key handler
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            async function sendMessage(text = input.value.trim()) {
                if (!text) return;
                
                // Disable input while sending
                input.disabled = true;
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<div class="loading"></div>';
                
                // Show user message
                addMessage(text, 'user');
                input.value = '';
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.assistant, 'assistant');
                        
                        // Show products if found (—Ç–æ–ª—å–∫–æ 2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
                        if (data.products && data.products.length > 0) {
                            const productsMsg = `üì¶ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –≠–Ω—Ç–µ—Ö (${data.products.length} —à—Ç.):`;
                            addMessage(productsMsg, 'assistant');
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 2 —Ç–æ–≤–∞—Ä–∞
                            data.products.slice(0, 2).forEach(product => {
                                const productText = `‚Ä¢ **${product.model}** (${product.power_w}–í—Ç, ${product.display_lumens}, ${product.ip_rating || 'IP –Ω–µ —É–∫–∞–∑–∞–Ω'}, ${product.category})`;
                                addMessage(productText, 'assistant');
                            });
                            
                            addMessage('üí° –•–æ—Ç–∏—Ç–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ PDF? –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email!', 'assistant');
                        }
                    } else {
                        const errorText = response.status === 429 ? '‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.' : 
                                        response.status === 500 ? '‚ùå –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' :
                                        '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                        addMessage(errorText, 'assistant');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'assistant');
                } finally {
                    // Re-enable input
                    input.disabled = false;
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                    input.focus();
                }
            }
            
            function addMessage(text, sender) {
                const div = document.createElement('div');
                div.className = `message ${sender}`;
                div.innerHTML = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold markdown
                    .replace(/\n/g, '<br>');  // Line breaks
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                // Auto-scroll animation
                messagesDiv.style.scrollBehavior = 'smooth';
            }
            
            // Initial welcome message ‚Äî –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–ô –î–ò–ê–õ–û–ì
            setTimeout(() => {
                addMessage('–ü—Ä–∏–≤–µ—Ç! –Ø AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≠–Ω—Ç–µ—Ö –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É –æ—Å–≤–µ—â–µ–Ω–∏—é. –ù–∞–ø–∏—à–∏—Ç–µ —Ç–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è (–æ—Ñ–∏—Å, —Ü–µ—Ö, —É–ª–∏—Ü–∞, —Å–∫–ª–∞–¥) –∏–ª–∏ –≤–∞—à –≤–æ–ø—Ä–æ—Å ‚Äî –ø–æ–¥–±–µ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ!', 'assistant');
            }, 500);
        });
    </script>
</body>
</html>