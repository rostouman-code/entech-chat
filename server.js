// API: AI —á–∞—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ ‚Äî –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–ô –î–ò–ê–õ–û–ì
app.post("/api/chat", async (req, res) => {
  try {
    const { message } = req.body;
    
    if (!message || typeof message !== 'string' || message.trim().length < 1) {
      return res.status(400).json({ 
        error: "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" 
      });
    }

    if (!openai) {
      return res.status(503).json({ 
        error: "AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" 
      });
    }

    logger.info(`Chat request: "${message.slice(0, 50)}..." from ${req.ip}`);

    // –ò—â–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ (—Å fallback lumens)
    const products = findProducts(message);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 2 –ª—É—á—à–∏—Ö —Ç–æ–≤–∞—Ä–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ
    const topProducts = products.slice(0, 2);
    const productCount = topProducts.length;
    
    const productText = productCount > 0 ? 
      `\n\n**üì¶ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ò–ó –ö–ê–¢–ê–õ–û–ì–ê –≠–ù–¢–ï–• (–¢–û–ü-${productCount}):**\n` +
      topProducts.map((p, i) => 
        `${i+1}. **${p.model || '–ú–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}** ` +
        `(${p.power_w || '?'}–í—Ç, ${p.display_lumens}, ` +
        `${p.ip_rating || 'IP –Ω–µ —É–∫–∞–∑–∞–Ω'}, ${p.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'})`
      ).join('\n') : '';

    // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Äî –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–ô –î–ò–ê–õ–û–ì –° –£–¢–û–ß–ù–ï–ù–ò–Ø–ú–ò
    const sysPrompt = `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≠–Ω—Ç–µ—Ö –ø–æ —Å–≤–µ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–µ. 
–¢–≤–æ—è —Ü–µ–ª—å: –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É —Å –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–æ–º –æ–± –æ—Å–≤–µ—â–µ–Ω–∏–∏ –∏ –ø–æ–ª—É—á–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ö–ü.

**–ü–†–ê–í–ò–õ–ê –î–ò–ê–õ–û–ì–ê:**
1. **–û–¢–í–ï–ß–ê–ô –ù–ê –õ–Æ–ë–û–ô –ó–ê–ü–†–û–°** ‚Äî –±—É–¥—å —Ç–æ —Ç–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–ª–∏ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å
2. **–†–ï–ö–û–ú–ï–ù–î–£–ô 1-2 –¢–û–í–ê–†–ê** –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ (–¢–û–ü-2 –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏). –î–ª—è —Å–≤–µ—Ç–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞: –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Ä–∞—Å—Å—á–∏—Ç–∞–π –ø–æ –º–æ—â–Ω–æ—Å—Ç–∏ (130 –ª–º/–í—Ç). –ü—Ä–∏–º–µ—Ä: 27–í—Ç ‚Üí 3510 –ª–º, 100–í—Ç ‚Üí 13000 –ª–º.
3. **–ü–û–°–õ–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô** –∑–∞–¥–∞–π 1-2 **—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
   - –î–ª—è **—Ü–µ—Ö/—Å–∫–ª–∞–¥**: –≤—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤ (3–º, 6–º, 10–º+), –ø–ª–æ—â–∞–¥—å (–º¬≤), —Ç–∏–ø –æ—Å–≤–µ—â–µ–Ω–∏—è (–æ–±—â–µ–µ/—Ä–∞–±–æ—á–∏–µ –∑–æ–Ω—ã)
   - –î–ª—è **–æ—Ñ–∏—Å**: –ø–ª–æ—â–∞–¥—å –∫–∞–±–∏–Ω–µ—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç, —Ç–∏–ø –æ—Å–≤–µ—â–µ–Ω–∏—è (–ø–æ—Ç–æ–ª–æ—á–Ω–æ–µ/–Ω–∞—Å—Ç–æ–ª—å–Ω–æ–µ)
   - –î–ª—è **—É–ª–∏—Ü–∞**: –¥–ª–∏–Ω–∞ —É–ª–∏—Ü—ã, —Ç–∏–ø –ø–æ–∫—Ä—ã—Ç–∏—è, –≤—ã—Å–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (4–º, 6–º, 8–º+)
   - –î–ª—è **–æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤**: —É—Ç–æ—á–Ω–∏ —Ç–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
4. **–ù–ï –Ω–∞–∑—ã–≤–∞–π —Ü–µ–Ω—ã** ‚Äî "–ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –ø–æ–¥ –≤–∞—à –ø—Ä–æ–µ–∫—Ç"
5. **–í–°–ï–ì–î–ê –∑–∞–∫–∞–Ω—á–∏–≤–∞–π CTA**: "–•–æ—Ç–∏—Ç–µ –ö–ü –≤ PDF —Å —Ä–∞—Å—á–µ—Ç–æ–º –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏? –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω/email"

**–ù–ê–ô–î–ï–ù–ù–´–ï –¢–û–í–ê–†–´ (–¢–û–ü-2 —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º —Å–≤–µ—Ç–æ–≤—ã–º –ø–æ—Ç–æ–∫–æ–º):**
${productText || '–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ –Ω–∞—à–µ–ª –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É ‚Äî –æ–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ —Ç–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.'}

**–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:**
- **–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ—Ç–≤–µ—á–∞—è –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞)
- **1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** (–º–æ–¥–µ–ª–∏ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –ª–º)
- **1-2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞** (–∫–æ—Ä–æ—Ç–∫–∏–π –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É)
- **–ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≠–Ω—Ç–µ—Ö** (–≥–∞—Ä–∞–Ω—Ç–∏—è 5 –ª–µ—Ç, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –†–§)
- **CTA** —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é

**–ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê:** ${message}

–û—Ç–≤–µ—á–∞–π **–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –¥–∏–∞–ª–æ–≥–æ–≤–æ**. –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å. –í–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –∫ —É—Ç–æ—á–Ω–µ–Ω–∏—é –¥–µ—Ç–∞–ª–µ–π –∏ –∑–∞—è–≤–∫–µ.`;

    // OpenAI v4 –≤—ã–∑–æ–≤
    const completion = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || "gpt-4o-mini",
      messages: [
        { 
          role: "system", 
          content: sysPrompt 
        },
        { 
          role: "user", 
          content: message.trim() 
        }
      ],
      temperature: 0.3,
      max_tokens: 500,
      top_p: 0.9
    });

    const assistantResponse = completion.choices[0].message.content;

    logger.info(`AI response generated (${completion.usage?.total_tokens || 'N/A'} tokens)`);
    
    res.json({ 
      assistant: assistantResponse.trim(),
      products: topProducts, // –¢–æ–ª—å–∫–æ —Ç–æ–ø-2 –≤ –æ—Ç–≤–µ—Ç–µ
      tokens: completion.usage || null
    });

  } catch (err) {
    logger.error(`Chat API error: ${err.message}`);
    
    // Graceful error handling
    if (err.status === 401) {
      res.status(503).json({ error: "AI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á)" });
    } else if (err.status === 429) {
      res.status(429).json({ error: "AI –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É." });
    } else {
      res.status(500).json({ 
        error: "–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å." 
      });
    }
  }
});